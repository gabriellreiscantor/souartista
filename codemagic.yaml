workflows:
  ios-workflow:
    name: iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m2
    integrations:
      app_store_connect: iOS SouArtista
    
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: aplicativo.souartista
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        VITE_SUPABASE_URL: "https://wjutvzmnvemrplpwbkyf.supabase.co"
        VITE_SUPABASE_PUBLISHABLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqdXR2em1udmVtcnBscHdia3lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDAyNjQsImV4cCI6MjA3OTE3NjI2NH0.JiOuFZcjDLvh7_gpfj7b_Zv5bK_8G2KmHAketLceCCk"
        VITE_SUPABASE_PROJECT_ID: "wjutvzmnvemrplpwbkyf"
      node: v20
      xcode: latest
      cocoapods: default

    scripts:
      - name: Install dependencies
        script: npm install
      
      - name: Install capacitor-assets
        script: npm install -g @capacitor/assets
      
      - name: Build web assets
        script: npm run build
      
      - name: Add and Sync Capacitor iOS
        script: |
          rm -rf ios
          PLATFORM=ios npx cap add ios
          PLATFORM=ios npx cap sync ios
      
      - name: Copy and Add GoogleService-Info.plist to Xcode Project
        script: |
          # Copy the plist file
          cp resources/GoogleService-Info.plist ios/App/App/

          # Add the file to Xcode project and target
          ruby <<RUBY
          require 'xcodeproj'
          
          project_path = 'ios/App/App.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
          
          # Get the main target
          target = project.targets.first
          
          # Get the App group
          app_group = project.main_group.find_subpath('App', false)
          
          # Check if file reference already exists
          file_ref = app_group.files.find { |f| f.path == 'GoogleService-Info.plist' }
          
          # If not, create it
          if file_ref.nil?
            file_ref = app_group.new_file('GoogleService-Info.plist')
          end
          
          # Add to resources build phase if not already there
          resources_phase = target.resources_build_phase
          unless resources_phase.files_references.include?(file_ref)
            resources_phase.add_file_reference(file_ref)
          end
          
          project.save
          
          puts "GoogleService-Info.plist added to Xcode project and target"
          RUBY
      
      - name: Add Firebase to Podfile
        script: |
          # Add Firebase Messaging pod to Podfile
          cd ios/App
          cat >> Podfile << 'EOF'

          # Firebase for Push Notifications
          pod 'Firebase/Messaging'
          EOF
      
      - name: Configure AppDelegate for Firebase Messaging
        script: |
          # Create AppDelegate.swift with Firebase initialization
          cat > ios/App/App/AppDelegate.swift << 'EOF'
          import UIKit
          import Capacitor
          import FirebaseCore
          import FirebaseMessaging

          @UIApplicationMain
          class AppDelegate: UIResponder, UIApplicationDelegate, MessagingDelegate {

              var window: UIWindow?

              func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
                  // Initialize Firebase
                  FirebaseApp.configure()
                  
                  // Set messaging delegate
                  Messaging.messaging().delegate = self
                  
                  // Register for remote notifications
                  application.registerForRemoteNotifications()
                  
                  return true
              }

              func applicationWillResignActive(_ application: UIApplication) {
              }

              func applicationDidEnterBackground(_ application: UIApplication) {
              }

              func applicationWillEnterForeground(_ application: UIApplication) {
              }

              func applicationDidBecomeActive(_ application: UIApplication) {
              }

              func applicationWillTerminate(_ application: UIApplication) {
              }

              func application(_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey: Any] = [:]) -> Bool {
                  return ApplicationDelegateProxy.shared.application(app, open: url, options: options)
              }

              func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
                  return ApplicationDelegateProxy.shared.application(application, continue: userActivity, restorationHandler: restorationHandler)
              }

              // MARK: - Push Notifications (APNs)
              func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
                  // Pass APNs token to Firebase
                  Messaging.messaging().apnsToken = deviceToken
                  // Also notify Capacitor
                  NotificationCenter.default.post(name: .capacitorDidRegisterForRemoteNotifications, object: deviceToken)
              }

              func application(_ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error) {
                  print("Failed to register for remote notifications: \(error)")
                  NotificationCenter.default.post(name: .capacitorDidFailToRegisterForRemoteNotifications, object: error)
              }
              
              // MARK: - Firebase Messaging Delegate
              func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {
                  print("Firebase FCM token: \(fcmToken ?? "nil")")
                  // Token will be handled by Capacitor Firebase Messaging plugin
              }
          }
          EOF
      
      - name: Add Push Notification Entitlement
        script: |
          cat > ios/App/App/App.entitlements << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>aps-environment</key>
            <string>production</string>
          </dict>
          </plist>
          EOF
          
          # Add entitlements to Xcode project
          ruby <<RUBY
          require 'xcodeproj'
          project_path = 'ios/App/App.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
          target = project.targets.first
          target.build_configurations.each do |config|
            config.build_settings['CODE_SIGN_ENTITLEMENTS'] = 'App/App.entitlements'
          end
          project.save
          RUBY
      
      - name: Set iOS version
        script: |
          cd ios/App
          agvtool new-version -all $PROJECT_BUILD_NUMBER
      
      - name: Generate App Icons and Splash Screens
        script: npx capacitor-assets generate --ios
      
      - name: Install CocoaPods
        script: cd ios/App && pod install
      
      - name: Initialize keychain
        script: keychain initialize
      
      - name: Add certificates to keychain
        script: keychain add-certificates
      
      - name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles
      
      - name: Build IPA
        script: |
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME"
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: false

  android-workflow:
    name: Android Build
    max_build_duration: 60
    instance_type: linux_x2
    
    environment:
      java: 17
      node: v20
      vars:
        VITE_SUPABASE_URL: "https://wjutvzmnvemrplpwbkyf.supabase.co"
        VITE_SUPABASE_PUBLISHABLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqdXR2em1udmVtcnBscHdia3lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDAyNjQsImV4cCI6MjA3OTE3NjI2NH0.JiOuFZcjDLvh7_gpfj7b_Zv5bK_8G2KmHAketLceCCk"
        VITE_SUPABASE_PROJECT_ID: "wjutvzmnvemrplpwbkyf"
      android_signing:
        - souartista_keystore
    
    scripts:
      - name: Install dependencies
        script: npm install
      
      - name: Install capacitor-assets
        script: npm install -g @capacitor/assets
      
      - name: Build web assets
        script: npm run build
      
      - name: Add and Sync Capacitor Android
        script: |
          rm -rf android
          npx cap add android
          npx cap sync android
      
      - name: Copy google-services.json
        script: cp resources/google-services.json android/app/
      
      - name: Generate App Icons and Splash Screens
        script: npx capacitor-assets generate --android
      
      - name: Set version code
        script: |
          cd android
          sed -i "s/versionCode 1/versionCode $PROJECT_BUILD_NUMBER/" app/build.gradle
      
      - name: Build Release AAB
        script: |
          cd android
          ./gradlew bundleRelease
    
    artifacts:
      - android/app/build/outputs/**/*.aab
      - android/app/build/outputs/**/*.apk
    
    publishing:
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
